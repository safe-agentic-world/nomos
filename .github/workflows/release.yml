name: Release

on:
  repository_dispatch:
    types:
      - publish-release
  workflow_dispatch:
    inputs:
      tag:
        description: Release tag to publish (for example v0.0.1)
        required: true
        type: string

permissions:
  contents: read

concurrency:
  group: release-${{ github.event.client_payload.tag || github.event.inputs.tag || github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
    steps:
      - name: Resolve release tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "repository_dispatch" ]]; then
            tag="${{ github.event.client_payload.tag }}"
          else
            tag="${{ github.event.inputs.tag }}"
          fi
          if [[ ! "${tag}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid release tag: ${tag}"
            exit 1
          fi
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"

      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: refs/tags/${{ steps.meta.outputs.tag }}
          persist-credentials: false

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.13"
          cache: true

      - name: Build release artifacts
        shell: bash
        run: |
          set -euo pipefail
          ROOT_DIR="${PWD}"
          mkdir -p dist
          VERSION="${{ steps.meta.outputs.tag }}"
          COMMIT="$(git rev-parse --short=12 HEAD)"
          BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          : > dist/nomos-checksums.txt
          for target in \
            "linux amd64 tar.gz" \
            "linux arm64 tar.gz" \
            "darwin amd64 tar.gz" \
            "darwin arm64 tar.gz" \
            "windows amd64 zip" \
            "windows arm64 zip"; do
            read -r GOOS_TARGET GOARCH_TARGET PACKAGE_FORMAT <<<"${target}"
            STAGE_DIR="$(mktemp -d)"
            BIN_NAME="nomos"
            if [[ "${GOOS_TARGET}" == "windows" ]]; then
              BIN_NAME="nomos.exe"
            fi
            GOOS="${GOOS_TARGET}" GOARCH="${GOARCH_TARGET}" \
              go build -ldflags "-X github.com/safe-agentic-world/nomos/internal/version.Version=${VERSION} -X github.com/safe-agentic-world/nomos/internal/version.Commit=${COMMIT} -X github.com/safe-agentic-world/nomos/internal/version.BuildDate=${BUILD_DATE}" \
              -o "${STAGE_DIR}/${BIN_NAME}" ./cmd/nomos
            OUT="dist/nomos-${GOOS_TARGET}-${GOARCH_TARGET}.${PACKAGE_FORMAT}"
            if [[ "${PACKAGE_FORMAT}" == "zip" ]]; then
              (cd "${STAGE_DIR}" && zip -q "${ROOT_DIR}/${OUT}" "${BIN_NAME}")
            else
              tar -C "${STAGE_DIR}" -czf "${OUT}" "${BIN_NAME}"
            fi
            (cd dist && sha256sum "nomos-${GOOS_TARGET}-${GOARCH_TARGET}.${PACKAGE_FORMAT}") >> dist/nomos-checksums.txt
            rm -rf "${STAGE_DIR}"
          done

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          files: dist/*
          generate_release_notes: true
