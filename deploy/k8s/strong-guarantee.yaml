apiVersion: v1
kind: ServiceAccount
metadata:
  name: nomos
  labels:
    app: nomos
automountServiceAccountToken: false
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: sample-agent
  labels:
    app: sample-agent
automountServiceAccountToken: false
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nomos-strong-config
  labels:
    app: nomos
data:
  config.json: |
    {
      "gateway": {
        "listen": ":8080",
        "transport": "http",
        "tls": {
          "enabled": true,
          "cert_file": "/tls/tls.crt",
          "key_file": "/tls/tls.key",
          "client_ca_file": "/tls/client-ca.pem",
          "require_mtls": true
        }
      },
      "runtime": {
        "stateless_mode": false,
        "strong_guarantee": true,
        "deployment_mode": "k8s"
      },
      "policy": {
        "policy_bundle_path": "/config/policy-bundle.json"
      },
      "executor": {
        "sandbox_enabled": true,
        "sandbox_profile": "container",
        "workspace_root": "/workspace"
      },
      "audit": {
        "sink": "sqlite:/audit/nomos.db"
      },
      "mcp": {
        "enabled": true
      },
      "approvals": {
        "enabled": false
      },
      "identity": {
        "principal": "system",
        "agent": "nomos",
        "environment": "prod",
        "api_keys": {
          "replace-me": "system"
        },
        "agent_secrets": {
          "nomos": "replace-me"
        },
        "oidc": {
          "enabled": true,
          "issuer": "https://issuer.example",
          "audience": "nomos",
          "public_key_path": "/tls/oidc.pub.pem"
        }
      }
    }
  policy-bundle.json: |
    {"version":"v1","rules":[{"id":"allow-readme","action_type":"fs.read","resource":"file://workspace/README.md","decision":"ALLOW"}]}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nomos
  labels:
    app: nomos
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nomos
  template:
    metadata:
      labels:
        app: nomos
    spec:
      serviceAccountName: nomos
      automountServiceAccountToken: false
      containers:
        - name: nomos
          image: nomos:local
          imagePullPolicy: IfNotPresent
          args:
            - serve
            - --config
            - /config/config.json
            - --policy-bundle
            - /config/policy-bundle.json
          ports:
            - name: http
              containerPort: 8080
          volumeMounts:
            - name: config
              mountPath: /config
              readOnly: true
            - name: workspace
              mountPath: /workspace
            - name: audit
              mountPath: /audit
            - name: tls
              mountPath: /tls
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: nomos-strong-config
        - name: workspace
          emptyDir: {}
        - name: audit
          emptyDir: {}
        - name: tls
          secret:
            secretName: nomos-tls
---
apiVersion: v1
kind: Service
metadata:
  name: nomos
  labels:
    app: nomos
spec:
  selector:
    app: nomos
  ports:
    - name: http
      port: 8080
      targetPort: http
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sample-agent
  labels:
    app: sample-agent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sample-agent
  template:
    metadata:
      labels:
        app: sample-agent
    spec:
      serviceAccountName: sample-agent
      automountServiceAccountToken: false
      containers:
        - name: sample-agent
          image: busybox:1.36
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - "sleep 3600"
          securityContext:
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nomos-egress
  labels:
    app: nomos
spec:
  podSelector:
    matchLabels:
      app: nomos
  policyTypes:
    - Egress
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: nomos
  egress:
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: sample-agent-egress
  labels:
    app: sample-agent
spec:
  podSelector:
    matchLabels:
      app: sample-agent
  policyTypes:
    - Egress
    - Ingress
  ingress: []
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: nomos
      ports:
        - protocol: TCP
          port: 8080
